// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  password  String
  type      UserType
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  student            Student?
  hod                Hod?
  faculty            Faculty?
  announcements      Announcement[]          @relation("AnnouncementCreator")
  teachingSessions   FacultyBatchSubject[]   @relation("FacultyTeaching")
  conductedSessions  AttendanceSession[]     @relation("SessionFaculty")
  attendanceRecords  AttendanceRecord[]      @relation("StudentAttendance")
  markedAttendance   AttendanceRecord[]      @relation("MarkedBy")
  timetableSlots     TimetableSlot[]         @relation("TimetableFaculty")
  createdAssignments Assignment[]            @relation("AssignmentCreator")
  submissions        AssignmentSubmission[]  @relation("StudentSubmissions")
  gradedSubmissions  AssignmentSubmission[]  @relation("AssignmentGrader")
  notifications      Notification[]          @relation("UserNotifications")
  sentNotifications  Notification[]          @relation("SentNotifications")
  syllabusProgress   SyllabusProgress[]      @relation("FacultyProgress")
  topicProgress      SyllabusTopicProgress[] @relation("FacultyTopicProgress")

  @@index([email])
  @@index([type])
}

model Student {
  userId     Int      @id
  rollNumber String   @unique // Changed to String for flexibility
  course     String
  batchId    Int? // Foreign key to Batches
  phone      String? // Phone number for student contact
  isVerified Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  user  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  batch Batches? @relation(fields: [batchId], references: [BatchId])

  @@index([rollNumber])
  @@index([batchId])
}

model Hod {
  userId     Int      @id // Changed to camelCase for consistency
  department String
  phone      String // Changed to String for phone numbers
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([department])
}

model Faculty {
  userId     Int      @id // Changed to camelCase for consistency
  phone      String // Changed to String for phone numbers
  department String
  isHOD      Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([department])
  @@index([isHOD])
}

model Batches {
  BatchId         Int      @id @default(autoincrement())
  BatchName       String
  course          String
  currentSemester Int      @default(1) // Current semester for the batch
  // capacity  Int      @default(60)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt

  students           Student[] // One-to-many relationship
  announcements      Announcement[]
  facultySubjects    FacultyBatchSubject[]
  attendanceSessions AttendanceSession[]     @relation("SessionBatch")
  timetableSlots     TimetableSlot[]         @relation("TimetableBatch")
  assignments        Assignment[]
  syllabusProgress   SyllabusProgress[]      @relation("BatchProgress")
  topicProgress      SyllabusTopicProgress[] @relation("BatchTopicProgress")

  @@index([course])
  @@index([BatchName])
}

model Announcement {
  id         Int      @id @default(autoincrement())
  title      String
  content    String
  department String? // Optional: specific department or null for all
  batchId    Int? // Optional: specific batch or null for all batches
  hodId      Int // ID of the HOD who created the announcement
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  hod   User     @relation("AnnouncementCreator", fields: [hodId], references: [id], onDelete: Cascade)
  batch Batches? @relation(fields: [batchId], references: [BatchId])

  @@index([department])
  @@index([batchId])
  @@index([createdAt])
}

enum UserType {
  STUDENT
  FACULTY
  HOD
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

enum AssignmentStatus {
  DRAFT
  PUBLISHED
  CLOSED
}

enum SubmissionStatus {
  NOT_SUBMITTED
  SUBMITTED
  GRADED
  LATE_SUBMISSION
}

enum NotificationType {
  ANNOUNCEMENT
  ASSIGNMENT
  ATTENDANCE
  GENERAL
  URGENT
}

enum NotificationStatus {
  UNREAD
  READ
  ARCHIVED
}

enum SyllabusTopicStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

enum SyllabusUnitStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

// Subject model
model Subject {
  id         Int      @id @default(autoincrement())
  name       String
  code       String   @unique
  department String
  semester   Int
  credits    Int      @default(3)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  facultyBatchSubjects FacultyBatchSubject[]
  sessions             AttendanceSession[]
  timetableSlots       TimetableSlot[]
  assignments          Assignment[]
  syllabusUnits        SyllabusUnit[]
  syllabusProgress     SyllabusProgress[]    @relation("SyllabusProgress")

  @@index([department])
  @@index([semester])
  @@index([code])
}

// Faculty-Batch-Subject mapping
model FacultyBatchSubject {
  id           Int      @id @default(autoincrement())
  facultyId    Int
  batchId      Int
  subjectId    Int
  academicYear String // e.g., "2024-25"
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @default(now()) @updatedAt

  faculty User    @relation("FacultyTeaching", fields: [facultyId], references: [id], onDelete: Cascade)
  batch   Batches @relation(fields: [batchId], references: [BatchId], onDelete: Cascade)
  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([facultyId, batchId, subjectId, academicYear])
  @@index([facultyId])
  @@index([batchId])
  @@index([subjectId])
}

// Attendance Session (each class)
model AttendanceSession {
  id              Int      @id @default(autoincrement())
  subjectId       Int
  batchId         Int
  facultyId       Int
  timetableSlotId Int? // Optional: link to timetable slot if created from schedule
  date            DateTime
  startTime       String // e.g., "09:00"
  endTime         String // e.g., "10:00"
  topic           String? // Optional topic covered
  sessionType     String   @default("LECTURE") // LECTURE, LAB, TUTORIAL
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt

  subject       Subject                 @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  batch         Batches                 @relation("SessionBatch", fields: [batchId], references: [BatchId], onDelete: Cascade)
  faculty       User                    @relation("SessionFaculty", fields: [facultyId], references: [id], onDelete: Cascade)
  timetableSlot TimetableSlot?          @relation(fields: [timetableSlotId], references: [id], onDelete: SetNull)
  records       AttendanceRecord[]
  topicProgress SyllabusTopicProgress[]

  @@index([subjectId])
  @@index([batchId])
  @@index([facultyId])
  @@index([date])
  @@index([timetableSlotId])
}

// Individual attendance records
model AttendanceRecord {
  id        Int              @id @default(autoincrement())
  sessionId Int
  studentId Int
  status    AttendanceStatus @default(ABSENT)
  markedAt  DateTime         @default(now())
  markedBy  Int // Faculty who marked
  remarks   String? // Optional remarks

  session AttendanceSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student User              @relation("StudentAttendance", fields: [studentId], references: [id], onDelete: Cascade)
  faculty User              @relation("MarkedBy", fields: [markedBy], references: [id], onDelete: Cascade)

  @@unique([sessionId, studentId])
  @@index([sessionId])
  @@index([studentId])
  @@index([status])
}

// Timetable Configuration (versioned to maintain historical integrity)
model TimetableVersion {
  id           Int       @id @default(autoincrement())
  name         String // e.g., "Odd Semester 2024-25"
  academicYear String // e.g., "2024-25"
  semester     Int // 1-8
  validFrom    DateTime
  validTo      DateTime?
  isActive     Boolean   @default(true)
  createdBy    Int // HOD who created this timetable
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @default(now()) @updatedAt

  slots TimetableSlot[]

  @@index([academicYear])
  @@index([semester])
  @@index([isActive])
  @@index([validFrom])
}

// Individual timetable slots (class schedules)
model TimetableSlot {
  id                 Int      @id @default(autoincrement())
  timetableVersionId Int
  dayOfWeek          Int // 1=Monday, 7=Sunday
  startTime          String // e.g., "09:00"
  endTime            String // e.g., "10:00"
  subjectId          Int
  batchId            Int
  facultyId          Int
  roomNumber         String? // Optional classroom
  sessionType        String   @default("LECTURE") // LECTURE, LAB, TUTORIAL
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @default(now()) @updatedAt

  timetableVersion   TimetableVersion    @relation(fields: [timetableVersionId], references: [id], onDelete: Cascade)
  subject            Subject             @relation(fields: [subjectId], references: [id], onDelete: Restrict)
  batch              Batches             @relation("TimetableBatch", fields: [batchId], references: [BatchId], onDelete: Restrict)
  faculty            User                @relation("TimetableFaculty", fields: [facultyId], references: [id], onDelete: Restrict)
  attendanceSessions AttendanceSession[]

  @@index([timetableVersionId])
  @@index([dayOfWeek])
  @@index([batchId])
  @@index([facultyId])
  @@index([subjectId])
}

// Assignment models
model Assignment {
  id            Int              @id @default(autoincrement())
  title         String
  description   String
  subjectId     Int
  batchId       Int
  facultyId     Int
  totalMarks    Int              @default(100)
  dueDate       DateTime
  status        AssignmentStatus @default(DRAFT)
  attachmentUrl String?
  instructions  String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @default(now()) @updatedAt

  subject     Subject                @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  batch       Batches                @relation(fields: [batchId], references: [BatchId], onDelete: Cascade)
  faculty     User                   @relation("AssignmentCreator", fields: [facultyId], references: [id], onDelete: Cascade)
  submissions AssignmentSubmission[]

  @@index([subjectId])
  @@index([batchId])
  @@index([facultyId])
  @@index([dueDate])
  @@index([status])
}

model AssignmentSubmission {
  id            Int              @id @default(autoincrement())
  assignmentId  Int
  studentId     Int
  content       String?
  attachmentUrl String?
  submittedAt   DateTime?
  status        SubmissionStatus @default(NOT_SUBMITTED)
  marks         Int?
  feedback      String?
  gradedBy      Int?
  gradedAt      DateTime?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @default(now()) @updatedAt

  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student    User       @relation("StudentSubmissions", fields: [studentId], references: [id], onDelete: Cascade)
  grader     User?      @relation("AssignmentGrader", fields: [gradedBy], references: [id], onDelete: SetNull)

  @@unique([assignmentId, studentId])
  @@index([assignmentId])
  @@index([studentId])
  @@index([status])
}

// Notifications model for better notification management
model Notification {
  id         Int                @id @default(autoincrement())
  title      String
  message    String
  type       NotificationType
  userId     Int // Who should receive this notification
  senderId   Int? // Who sent this notification (optional)
  status     NotificationStatus @default(UNREAD)
  metadata   Json? // Additional data (assignment ID, announcement ID, etc.)
  createdAt  DateTime           @default(now())
  readAt     DateTime?
  archivedAt DateTime?

  user   User  @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)
  sender User? @relation("SentNotifications", fields: [senderId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

// Syllabus structure models
model SyllabusUnit {
  id          Int      @id @default(autoincrement())
  subjectId   Int
  unitNumber  Int // Unit 1, 2, 3, etc.
  title       String
  description String?
  weightage   Int      @default(0) // Marks/percentage weightage
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  subject  Subject            @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  topics   SyllabusTopic[]
  progress SyllabusProgress[] @relation("UnitProgress")

  @@unique([subjectId, unitNumber])
  @@index([subjectId])
}

model SyllabusTopic {
  id             Int      @id @default(autoincrement())
  unitId         Int
  topicNumber    Int // Topic 1.1, 1.2, etc.
  title          String
  description    String?
  estimatedHours Int      @default(1) // Expected teaching hours
  createdAt      DateTime @default(now())
  updatedAt      DateTime @default(now()) @updatedAt

  unit     SyllabusUnit            @relation(fields: [unitId], references: [id], onDelete: Cascade)
  progress SyllabusTopicProgress[]

  @@unique([unitId, topicNumber])
  @@index([unitId])
}

// Progress tracking for faculty-batch-subject combinations
model SyllabusProgress {
  id                Int                @id @default(autoincrement())
  facultyId         Int
  batchId           Int
  subjectId         Int
  unitId            Int
  status            SyllabusUnitStatus @default(NOT_STARTED)
  completionPercent Int                @default(0) // 0-100
  startedAt         DateTime?
  completedAt       DateTime?
  notes             String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @default(now()) @updatedAt

  faculty User         @relation("FacultyProgress", fields: [facultyId], references: [id], onDelete: Cascade)
  batch   Batches      @relation("BatchProgress", fields: [batchId], references: [BatchId], onDelete: Cascade)
  subject Subject      @relation("SyllabusProgress", fields: [subjectId], references: [id], onDelete: Cascade)
  unit    SyllabusUnit @relation("UnitProgress", fields: [unitId], references: [id], onDelete: Cascade)

  @@unique([facultyId, batchId, subjectId, unitId])
  @@index([facultyId])
  @@index([batchId])
  @@index([subjectId])
}

// Topic-level progress tracking
model SyllabusTopicProgress {
  id        Int                 @id @default(autoincrement())
  facultyId Int
  batchId   Int
  topicId   Int
  status    SyllabusTopicStatus @default(NOT_STARTED)
  taughtAt  DateTime?
  sessionId Int? // Link to attendance session if taught
  notes     String?
  createdAt DateTime            @default(now())
  updatedAt DateTime            @default(now()) @updatedAt

  faculty User               @relation("FacultyTopicProgress", fields: [facultyId], references: [id], onDelete: Cascade)
  batch   Batches            @relation("BatchTopicProgress", fields: [batchId], references: [BatchId], onDelete: Cascade)
  topic   SyllabusTopic      @relation(fields: [topicId], references: [id], onDelete: Cascade)
  session AttendanceSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  @@unique([facultyId, batchId, topicId])
  @@index([facultyId])
  @@index([batchId])
  @@index([topicId])
}
